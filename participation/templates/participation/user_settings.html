{% extends 'participation/base.html' %}

{% block title %}
用户中心 - 我的资料
{% endblock %}

{% block css %}
{{ block.super }}
<style type="text/css">
.new-msg-badge {
    margin-left: 5px;
    margin-bottom: 5px;
}
.weui-btn-area {
    margin-top: 5px;
    margin-bottom: 15px;
}
.photo_input_wrapper {
    position: relative;
}
#photo_input {
    position: absolute;
    top: 0;
    height: 100%;
    width: 100%;
    opacity: 0;
}
#photo_canvas {
    display: none;
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block body %}
<div class="bottom-nav">
    <div class="bottom-nav-tab"><a class="bottom-nav-tab-text" href="/activities">活动</a></div>
    <div class="bottom-nav-tab"><a class="bottom-nav-tab-text" href="/messages">消息</a></div>
    <div class="bottom-nav-tab active"><a class="bottom-nav-tab-text" href="/settings">设置</a></div>
</div>

<div class="navbar-header navbar-header-user">
    <span class="navbar-header-text">
        欢迎你，{{ userinfo.name }}老师！
    </span>
</div>

<div class="user-content-wrapper">
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">用户名</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" name="username" disabled value="{{ userinfo.username }}">
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">真实姓名</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" name="real_name" disabled value="{{ userinfo.name }}">
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">性别</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" name="sex" disabled value="{{ userinfo.sex_text }}">
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">工号</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" name="wid" disabled value="{{ userinfo.wid }}">
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">所属单位</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" name="department" disabled value="{{ userinfo.department_text }}">
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">所属公会</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="text" name="sub_union" disabled value="{{ userinfo.sub_union_text }}">
            </div>
        </div>        
    </div>

    <div class="weui-cells__title">照片</div>
    <div class="weui-btn-area">
        <div class="photo_input_wrapper">
            <button class="weui-btn weui-btn_default" id="upload_btn">
                <span>点击上传照片</span>
            </button>
            <input type="file" id="photo_input">    
        </div>
    </div>
    <div class="weui-cells__tips">我们会使用您的照片制作活动奖励</div>
    <div class="canvas_wrapper">
        <canvas id="photo_canvas" width="409" height="504"></canvas>
    </div>


    <div class="weui-cells__title">联系方式</div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">手机号码</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="tel" placeholder="请输入手机号码" name="mobile" value="{{ userinfo.mobile }}">         
            </div>
        </div>
    </div>
    <div class="weui-cells__tips">我们可能会向您的手机发送通知</div>
    <div class="weui-cells weui-cells_form form-margin-0">
        <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label">邮箱地址</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" type="email" placeholder="请输入邮箱地址" name="email" value="{{ userinfo.email }}">
            </div>
        </div>
    </div>
    <div class="weui-cells__tips">我们可能会向您的邮箱发送通知</div>
    <div class="weui-btn-area">
        <button class="weui-btn weui-btn_default" onclick="setInfo()">
            <span>确认修改联系方式</span>
        </button>
    </div>


    <div class="weui-cells__title">密码修改</div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <input class="weui-input" type="password" placeholder="请输入新密码" name="pwd_new">         
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <input class="weui-input" type="password" placeholder="请再次输入新密码" name="pwd_new_2">         
            </div>
        </div>        
    </div>
    <div class="weui-btn-area">
        <button class="weui-btn weui-btn_default" onclick="setPassword()">
            <span>确认修改密码</span>
        </button>
    </div>

    <div class="weui-cells__title">退出登录</div>
    <div class="weui-btn-area">
        <button class="weui-btn weui-btn_warn" id="logout_btn" onclick="logout()">
            <span>登出</span>
        </button>
    </div>
</div>
{% endblock %}

{% block js %}
{{ block.super }}
<script type="text/javascript">
logout = function() {
    window.location.href = '/logout';
}

setInfo = function() {
    var mobile = $('input[name="mobile"]').val();
    var email = $('input[name="email"]').val();
    $.post('/settings/set', {
        mobile: mobile,
        email: email
    })
    .done(function(data, status) {
        if(data.status == 'success') {
            weui.toast(data.msg, {duration: 3000});
        }
        else if(data.status == 'error') {
            weui.topTips(data.msg, 3000);
        }
        else {
            weui.topTips('未知错误，请稍后再试', 3000);
        }
    })
    .fail(function() {
        weui.topTips('网络状况不佳，请稍后再试', 3000);
    })
}
setPassword = function() {
    var pwd_1 = $('input[name="pwd_new"]').val();
    var pwd_2 = $('input[name="pwd_new_2"]').val();
    if(pwd_1 != pwd_2) {
        weui.topTips('您两次输入的密码不一致，请重新输入！', 3000);
        return;
    }
    if(pwd_1.length < 6) {
        weui.topTips('密码不能少于6位！', 3000);
        return;
    }
    var pwd_hash = md5(pwd_1);
    $.post('/settings/rstpwd', {
        password: pwd_hash
    })
    .done(function(data, status) {
        if(data.status == 'success') {
            weui.toast(data.msg, {duration: 3000});
        }
        else if(data.status == 'error') {
            weui.topTips(data.msg, 3000);
        }
        else {
            weui.topTips('未知错误，请稍后再试', 3000);
        }
    })
    .fail(function() {
        weui.topTips('网络状况不佳，请稍后再试', 3000);
    })
}

function dataUrlToBlob(dataurl) {
  var arr = dataurl.split(',');
  var mime = arr[0].match(/:(.*?);/)[1];
  var bstr = atob(arr[1]);
  var n = bstr.length;
  var u8arr = new Uint8Array(n);
  while(n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  return new Blob([u8arr], {type: mime});
}

var old_photo = ''
window.reader = new FileReader();
window.posterImg = new Image();

$('#photo_input').on('change', function() {
    $('#photo_canvas').css('display', 'block');
    var file = this.files[0];
    if(file) {
        window.reader.readAsDataURL(file);
    }
});
window.reader.onload = function() {
    window.posterImg.src = window.reader.result;
};
window.posterImg.onload = function() {
    $('#photo_canvas')[0].getContext('2d').drawImage(window.posterImg, 0, 0, 409, 504);
    $('#photo_input').css('display', 'none');
    $('#upload_btn').html('上传中 ...')
    var photo_blob = dataUrlToBlob($('#photo_canvas')[0].toDataURL('image/jpeg'));
    var data = new FormData();
    data.append('photo', photo_blob);
    $.ajax({
        url: '/upload',
        type: 'POST',
        data: data,
        cache: false,
        processData: false,
        contentType: false
    })
    .done(function(data, status) {
        if(data.status == 'success') {
            weui.toast(data.msg, {duration: 3000});
        }
        else if(data.status == 'error') {
            weui.topTips(data.msg, 3000);
        }
        else {
            weui.topTips('未知错误，请稍后再试', 3000);
        }
    })
    .fail(function() {
        weui.topTips('网络状况不佳，请稍后再试', 3000);
    })
    .always(function() {
        $('#photo_input').css('display', 'block');
        $('#upload_btn').html('点击上传照片');
    });
};

if(old_photo) {
window.posterImg.src = old_poster;
$('#photo_canvas').css('display', 'block');
}
</script>
{% endblock %}